#!/bin/bash

# =============================================================================
# Claude Config Switcher (CCS) - Claude API é…ç½®ç®¡ç†å·¥å…·
# 
# åŠŸèƒ½ï¼š
# - ç®¡ç†å¤šä¸ª Claude API é…ç½®
# - ç¾è§‚çš„äº¤äº’å¼ç•Œé¢
# - æ”¯æŒæ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹ã€åˆ‡æ¢é…ç½®
# - å…¼å®¹ Linux å’Œ Mac
# - é›†æˆ Claude Code è®¾ç½®æ–‡ä»¶ç”Ÿæˆ
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# - `ccs`                : æ˜¾ç¤ºäº¤äº’å¼èœå•
# - `ccs <åç§°>`         : ç›´æ¥åˆ‡æ¢åˆ°æŒ‡å®šé…ç½®  
# - `ccs <æ•°å­—>`         : åˆ‡æ¢åˆ°åˆ—è¡¨ä¸­ç¬¬Nä¸ªé…ç½®
# - `ccs add`           : æ·»åŠ æ–°é…ç½®
# - `ccs delete`        : åˆ é™¤é…ç½®
# - `ccs edit`          : ç¼–è¾‘é…ç½®
# - `ccs list`          : åˆ—å‡ºæ‰€æœ‰é…ç½®
# - `ccs help`          : æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
# =============================================================================

set -euo pipefail

# --- å…¨å±€å˜é‡ ---
SCRIPT_NAME="Claude Config Switcher"
VERSION="1.0.0"
CLAUDE_DIR="${HOME}/.claude"
KEYS_FILE="${CLAUDE_DIR}/keys.conf"
SETTINGS_FILE="${CLAUDE_DIR}/settings.json"
CURRENT_FILE="${CLAUDE_DIR}/current"
TEMPLATE_FILE="${CLAUDE_DIR}/template.json"
VERSION_CACHE="${CLAUDE_DIR}/.version_cache"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[0;37m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# å›¾æ ‡å®šä¹‰
ICON_SUCCESS="âœ…"
ICON_ERROR="âŒ"
ICON_WARNING="âš ï¸"
ICON_INFO="â„¹ï¸"
ICON_ARROW="â¤"
ICON_BULLET="â€¢"
ICON_CONFIG="ğŸ”§"
ICON_CLAUDE="ğŸ¤–"

# GitHubç”¨æˆ·ä¿¡æ¯
GITHUB_USER="zhiqing0205"
REPO_URL="https://github.com/${GITHUB_USER}/ClaudeCodeSwitchConfig"

# =============================================================================
# è¾…åŠ©å‡½æ•°
# =============================================================================

# æ‰“å°å½©è‰²æ¶ˆæ¯
print_color() {
    local color="$1"
    local message="$2"
    printf "${color}%s${NC}\n" "$message"
}

# æ‰“å°æ ‡é¢˜
print_title() {
    local title="$1"
    echo
    print_color "$BOLD$CYAN" "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    printf "${BOLD}${CYAN}â•‘${NC}${BOLD}%-78s${CYAN}â•‘${NC}\n" "  $ICON_CLAUDE $SCRIPT_NAME $VERSION - $title"
    print_color "$BOLD$CYAN" "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo
}

# æ‰“å°åˆ†å‰²çº¿
print_separator() {
    print_color "$CYAN" "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
}

# æˆåŠŸæ¶ˆæ¯
print_success() {
    print_color "$GREEN" "$ICON_SUCCESS $1"
}

# é”™è¯¯æ¶ˆæ¯
print_error() {
    print_color "$RED" "$ICON_ERROR $1" >&2
}

# è­¦å‘Šæ¶ˆæ¯
print_warning() {
    print_color "$YELLOW" "$ICON_WARNING $1"
}

# ä¿¡æ¯æ¶ˆæ¯
print_info() {
    print_color "$BLUE" "$ICON_INFO $1"
}

# ä»é…ç½®æ–‡ä»¶è·å–å€¼
get_config_value() {
    local file="$1"
    local section="$2"
    local key="$3"
    
    awk -v section="$section" -v key="$key" '
        $0 == "[" section "]" { in_section = 1; next }
        in_section && /^\s*\[.*\]\s*$/ { in_section = 0; exit }
        in_section {
            if (index($0, key " =") == 1 || index($0, key "=") == 1) {
                split($0, parts, "=")
                if (length(parts) > 1) {
                    value = parts[2]
                    for (i = 3; i <= length(parts); i++) {
                        value = value "=" parts[i]
                    }
                    sub(/^[ \t]*/, "", value)
                    sub(/[ \t]*$/, "", value)
                    print value
                    exit
                }
            }
        }
    ' "$file"
}

# è·å–æ‰€æœ‰é…ç½®åç§°
get_all_configs() {
    if [[ ! -f "$KEYS_FILE" ]]; then
        return 0
    fi
    awk '/^\[.*\]$/ { gsub(/[\[\]]/, "", $0); print }' "$KEYS_FILE"
}

# è·å–å½“å‰æ¿€æ´»çš„é…ç½®
get_current_config() {
    if [[ -f "$CURRENT_FILE" ]]; then
        cat "$CURRENT_FILE"
    fi
}

# æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ¨
config_exists() {
    local config_name="$1"
    grep -q "^\[$config_name\]$" "$KEYS_FILE" 2>/dev/null
}

# åˆå§‹åŒ–Claudeç›®å½•
init_claude_dir() {
    if [[ ! -d "$CLAUDE_DIR" ]]; then
        print_info "åˆ›å»º Claude é…ç½®ç›®å½•: $CLAUDE_DIR"
        if ! mkdir -p "$CLAUDE_DIR" || ! chmod 700 "$CLAUDE_DIR"; then
            print_error "æ— æ³•åˆ›å»ºæˆ–è®¾ç½®ç›®å½•æƒé™: $CLAUDE_DIR"
            return 1
        fi
    fi
    
    if [[ ! -f "$KEYS_FILE" ]]; then
        touch "$KEYS_FILE"
        chmod 600 "$KEYS_FILE"
    fi
    
    return 0
}

# æ£€æŸ¥æ›´æ–°
check_for_updates() {
    # é™é»˜æ¨¡å¼ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·ä½“éªŒ
    local should_check=true
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç»œå’Œå¿…è¦å·¥å…·
    if ! command -v curl >/dev/null 2>&1; then
        return 0
    fi
    
    # æ£€æŸ¥ç¼“å­˜ï¼Œé¿å…é¢‘ç¹æ£€æŸ¥ï¼ˆæ¯6å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼‰
    if [[ -f "$VERSION_CACHE" ]]; then
        local last_check
        last_check=$(stat -c %Y "$VERSION_CACHE" 2>/dev/null || echo 0)
        local current_time
        current_time=$(date +%s)
        local time_diff=$((current_time - last_check))
        
        # 6å°æ—¶ = 21600ç§’
        if [[ $time_diff -lt 21600 ]]; then
            return 0
        fi
    fi
    
    # è·å–å½“å‰è„šæœ¬çš„MD5
    local current_md5
    if command -v md5sum >/dev/null 2>&1; then
        current_md5=$(md5sum "$0" 2>/dev/null | cut -d' ' -f1)
    elif command -v md5 >/dev/null 2>&1; then
        current_md5=$(md5 -q "$0" 2>/dev/null)
    else
        return 0
    fi
    
    # è·å–è¿œç¨‹è„šæœ¬çš„MD5ï¼ˆè¶…æ—¶5ç§’ï¼‰
    local remote_md5
    local remote_script
    remote_script=$(curl -fsSL --connect-timeout 5 --max-time 10 "$REPO_URL/raw/main/ccs" 2>/dev/null)
    
    if [[ $? -eq 0 && -n "$remote_script" ]]; then
        if command -v md5sum >/dev/null 2>&1; then
            remote_md5=$(echo "$remote_script" | md5sum | cut -d' ' -f1)
        elif command -v md5 >/dev/null 2>&1; then
            remote_md5=$(echo "$remote_script" | md5)
        fi
        
        # æ›´æ–°æ£€æŸ¥ç¼“å­˜
        echo "$current_md5" > "$VERSION_CACHE"
        
        # å¦‚æœMD5ä¸åŒï¼Œæç¤ºæ›´æ–°
        if [[ -n "$remote_md5" && "$current_md5" != "$remote_md5" ]]; then
            echo
            print_warning "æ£€æµ‹åˆ° CCS æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼"
            read -rp "$(print_color "$BOLD$WHITE" "æ˜¯å¦ç«‹å³æ›´æ–°? (Y/n): ")" update_confirm
            
            if [[ ! "$update_confirm" =~ ^[Nn]$ ]]; then
                print_info "æ­£åœ¨æ›´æ–° CCS..."
                
                # å¤‡ä»½å½“å‰ç‰ˆæœ¬
                local backup_file="${0}.backup.$(date +%Y%m%d_%H%M%S)"
                cp "$0" "$backup_file"
                
                # ä¸‹è½½æ–°ç‰ˆæœ¬
                if echo "$remote_script" > "$0"; then
                    chmod +x "$0"
                    print_success "CCS æ›´æ–°æˆåŠŸï¼"
                    print_info "å¤‡ä»½æ–‡ä»¶: $backup_file"
                    echo
                    print_info "é‡æ–°å¯åŠ¨ CCS..."
                    echo
                    exec "$0" "$@"
                else
                    print_error "æ›´æ–°å¤±è´¥ï¼Œå·²æ¢å¤åŸç‰ˆæœ¬"
                    cp "$backup_file" "$0"
                    rm -f "$backup_file"
                fi
            else
                print_info "å·²è·³è¿‡æ›´æ–°ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶ä¼šå†æ¬¡æ£€æŸ¥"
            fi
            echo
        fi
    fi
}

# å¼ºåˆ¶æ›´æ–°
force_update() {
    print_title "æ‰‹åŠ¨æ›´æ–° CCS"
    
    # æ£€æŸ¥å¿…è¦å·¥å…·
    if ! command -v curl >/dev/null 2>&1; then
        print_error "éœ€è¦ curl å·¥å…·æ¥ä¸‹è½½æ›´æ–°"
        return 1
    fi
    
    print_info "æ­£åœ¨æ£€æŸ¥è¿œç¨‹ç‰ˆæœ¬..."
    
    # è·å–å½“å‰è„šæœ¬çš„MD5
    local current_md5
    if command -v md5sum >/dev/null 2>&1; then
        current_md5=$(md5sum "$0" 2>/dev/null | cut -d' ' -f1)
    elif command -v md5 >/dev/null 2>&1; then
        current_md5=$(md5 -q "$0" 2>/dev/null)
    else
        print_error "æ— æ³•è®¡ç®—æ–‡ä»¶MD5ï¼Œè¯·å®‰è£… md5sum æˆ– md5 å·¥å…·"
        return 1
    fi
    
    # è·å–è¿œç¨‹è„šæœ¬
    local remote_script
    remote_script=$(curl -fsSL --connect-timeout 10 --max-time 30 "$REPO_URL/raw/main/ccs" 2>/dev/null)
    
    if [[ $? -ne 0 || -z "$remote_script" ]]; then
        print_error "æ— æ³•è¿æ¥åˆ° GitHub æˆ–ä¸‹è½½è¿œç¨‹è„šæœ¬"
        print_info "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•"
        return 1
    fi
    
    # è®¡ç®—è¿œç¨‹è„šæœ¬çš„MD5
    local remote_md5
    if command -v md5sum >/dev/null 2>&1; then
        remote_md5=$(echo "$remote_script" | md5sum | cut -d' ' -f1)
    elif command -v md5 >/dev/null 2>&1; then
        remote_md5=$(echo "$remote_script" | md5)
    fi
    
    print_info "å½“å‰ç‰ˆæœ¬ MD5: $current_md5"
    print_info "è¿œç¨‹ç‰ˆæœ¬ MD5: $remote_md5"
    
    if [[ "$current_md5" == "$remote_md5" ]]; then
        print_success "æ‚¨å·²ç»ä½¿ç”¨çš„æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼"
        return 0
    fi
    
    echo
    print_warning "å‘ç°æ–°ç‰ˆæœ¬ï¼Œå‡†å¤‡æ›´æ–°..."
    read -rp "$(print_color "$BOLD$WHITE" "ç¡®è®¤æ›´æ–°? (Y/n): ")" update_confirm
    
    if [[ "$update_confirm" =~ ^[Nn]$ ]]; then
        print_info "æ›´æ–°å·²å–æ¶ˆ"
        return 0
    fi
    
    print_info "æ­£åœ¨æ›´æ–° CCS..."
    
    # å¤‡ä»½å½“å‰ç‰ˆæœ¬
    local backup_file="${0}.backup.$(date +%Y%m%d_%H%M%S)"
    if ! cp "$0" "$backup_file"; then
        print_error "åˆ›å»ºå¤‡ä»½å¤±è´¥"
        return 1
    fi
    
    # ä¸‹è½½æ–°ç‰ˆæœ¬
    if echo "$remote_script" > "$0" && chmod +x "$0"; then
        print_success "CCS æ›´æ–°æˆåŠŸï¼"
        print_info "å¤‡ä»½æ–‡ä»¶: $backup_file"
        
        # æ›´æ–°ç‰ˆæœ¬ç¼“å­˜
        echo "$remote_md5" > "$VERSION_CACHE"
        
        echo
        print_info "é‡æ–°å¯åŠ¨ CCS..."
        echo
        exec "$0" "${@:2}"
    else
        print_error "æ›´æ–°å¤±è´¥ï¼Œæ­£åœ¨æ¢å¤åŸç‰ˆæœ¬..."
        cp "$backup_file" "$0"
        rm -f "$backup_file"
        return 1
    fi
}

# åˆ›å»ºé»˜è®¤æ¨¡æ¿æ–‡ä»¶
create_default_template() {
    if [[ ! -f "$TEMPLATE_FILE" ]]; then
        cat > "$TEMPLATE_FILE" << 'EOF'
{
  "env": {
    "ANTHROPIC_API_KEY": "{{API_KEY}}",
    "ANTHROPIC_BASE_URL": "{{BASE_URL}}",
    "CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC": 1
  },
  "permissions": {
    "allow": [
      "Bash(*)",
      "LS(*)",
      "Read(*)",
      "Write(*)",
      "Edit(*)",
      "MultiEdit(*)",
      "Glob(*)",
      "Grep(*)",
      "Task(*)",
      "WebFetch(*)",
      "WebSearch(*)",
      "TodoWrite(*)",
      "NotebookRead(*)",
      "NotebookEdit(*)"
    ],
    "deny": []
  },
  "apiKeyHelper": "echo '{{API_KEY}}'"
}
EOF
        print_info "å·²åˆ›å»ºé»˜è®¤æ¨¡æ¿æ–‡ä»¶: $TEMPLATE_FILE"
    fi
}

# ç”Ÿæˆsettings.jsonæ–‡ä»¶
generate_settings() {
    local config_name="$1"
    local api_key base_url
    api_key=$(get_config_value "$KEYS_FILE" "$config_name" "apiKey")
    base_url=$(get_config_value "$KEYS_FILE" "$config_name" "baseUrl")

    if [[ -z "$api_key" ]]; then
        print_error "åœ¨é…ç½® '$config_name' ä¸­æœªæ‰¾åˆ° 'apiKey'"
        return 1
    fi
    if [[ -z "$base_url" ]]; then
        print_error "åœ¨é…ç½® '$config_name' ä¸­æœªæ‰¾åˆ° 'baseUrl'"
        return 1
    fi

    # ç¡®ä¿æ¨¡æ¿æ–‡ä»¶å­˜åœ¨
    create_default_template

    # ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆsettings.json
    if [[ -f "$TEMPLATE_FILE" ]]; then
        # è¯»å–æ¨¡æ¿å¹¶æ›¿æ¢å˜é‡
        local template_content
        template_content=$(cat "$TEMPLATE_FILE")
        
        # æ›¿æ¢æ¨¡æ¿å˜é‡
        template_content="${template_content//\{\{API_KEY\}\}/$api_key}"
        template_content="${template_content//\{\{BASE_URL\}\}/$base_url}"
        template_content="${template_content//\{\{CONFIG_NAME\}\}/$config_name}"
        
        # å†™å…¥settings.json
        echo "$template_content" > "$SETTINGS_FILE"
    else
        print_error "æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: $TEMPLATE_FILE"
        return 1
    fi

    if [[ $? -eq 0 ]]; then
        print_success "æˆåŠŸåˆ‡æ¢åˆ°é…ç½®: '$config_name'"
        print_info "API å¯†é’¥: ...${api_key: -4}"
        print_info "Base URL: $base_url"
        return 0
    else
        print_error "å†™å…¥ settings.json å¤±è´¥"
        return 1
    fi
}

# =============================================================================
# æ ¸å¿ƒåŠŸèƒ½å‡½æ•°
# =============================================================================

# åˆ—å‡ºæ‰€æœ‰é…ç½®
list_configs() {
    local configs
    mapfile -t configs < <(get_all_configs)
    local current_config
    current_config=$(get_current_config)
    
    if [[ ${#configs[@]} -eq 0 ]]; then
        print_warning "æœªæ‰¾åˆ°ä»»ä½• Claude API é…ç½®"
        print_info "ä½¿ç”¨ 'ccs add' æ¥æ·»åŠ ç¬¬ä¸€ä¸ªé…ç½®"
        return 0
    fi
    
    print_title "Claude API é…ç½®åˆ—è¡¨"
    
    local i=1
    for config in "${configs[@]}"; do
        local status=""
        if [[ "$config" == "$current_config" ]]; then
            status="${GREEN}${BOLD}[å½“å‰]${NC}"
        fi
        
        # è·å–é…ç½®ä¿¡æ¯
        local base_url api_key
        base_url=$(get_config_value "$KEYS_FILE" "$config" "baseUrl")
        api_key=$(get_config_value "$KEYS_FILE" "$config" "apiKey")
        
        if [[ -n "$api_key" ]]; then
            api_key="...${api_key: -4}"
        else
            api_key="æœªè®¾ç½®"
        fi
        
        printf "${BOLD}${WHITE}%2d.${NC} ${CYAN}%-20s${NC} %s\n" "$i" "$config" "$status"
        printf "    ${BLUE}Base URL:${NC} %s\n" "${base_url:-æœªè®¾ç½®}"
        printf "    ${BLUE}API Key:${NC}  %s\n" "$api_key"
        echo
        i=$((i + 1))
    done
}

# æ·»åŠ æ–°é…ç½®
add_config() {
    print_title "æ·»åŠ æ–°çš„ Claude API é…ç½®"
    
    local config_name base_url api_key
    
    while true; do
        read -rp "$(print_color "$BOLD$WHITE" "é…ç½®åç§° (ä¾‹å¦‚: MyAPI): ")" config_name
        if [[ -z "$config_name" ]]; then
            print_error "é…ç½®åç§°ä¸èƒ½ä¸ºç©º"
            continue
        fi
        
        if config_exists "$config_name"; then
            print_error "é…ç½® '$config_name' å·²å­˜åœ¨"
            continue
        fi
        
        # éªŒè¯é…ç½®åç§°æ ¼å¼
        if [[ ! "$config_name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            print_error "é…ç½®åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œæ¨ªçº¿"
            continue
        fi
        
        break
    done
    
    while true; do
        read -rp "$(print_color "$BOLD$WHITE" "Base URL: ")" base_url
        if [[ -z "$base_url" ]]; then
            print_error "Base URL ä¸èƒ½ä¸ºç©º"
            continue
        fi
        break
    done
    
    while true; do
        read -rp "$(print_color "$BOLD$WHITE" "API Key: ")" api_key
        if [[ -z "$api_key" ]]; then
            print_error "API Key ä¸èƒ½ä¸ºç©º"
            continue
        fi
        break
    done
    
    # æ·»åŠ åˆ°é…ç½®æ–‡ä»¶
    {
        echo ""
        echo "[$config_name]"
        echo "baseUrl = $base_url"
        echo "apiKey = $api_key"
    } >> "$KEYS_FILE"
    
    print_success "é…ç½® '$config_name' æ·»åŠ æˆåŠŸï¼"
}

# åˆ é™¤é…ç½®
delete_config() {
    print_title "åˆ é™¤ Claude API é…ç½®"
    
    local configs
    mapfile -t configs < <(get_all_configs)
    
    if [[ ${#configs[@]} -eq 0 ]]; then
        print_warning "æ²¡æœ‰å¯åˆ é™¤çš„é…ç½®"
        return 0
    fi
    
    list_configs
    
    local selection
    read -rp "$(print_color "$BOLD$RED" "è¯·é€‰æ‹©è¦åˆ é™¤çš„é…ç½® (è¾“å…¥æ•°å­—æˆ–åç§°): ")" selection
    
    local config_to_delete=""
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºæ•°å­—
    if [[ "$selection" =~ ^[0-9]+$ ]]; then
        if [[ "$selection" -ge 1 && "$selection" -le ${#configs[@]} ]]; then
            config_to_delete="${configs[$((selection - 1))]}"
        else
            print_error "æ— æ•ˆçš„æ•°å­—é€‰æ‹©: $selection"
            return 1
        fi
    else
        if config_exists "$selection"; then
            config_to_delete="$selection"
        else
            print_error "é…ç½® '$selection' ä¸å­˜åœ¨"
            return 1
        fi
    fi
    
    # ç¡®è®¤åˆ é™¤
    print_warning "å³å°†åˆ é™¤é…ç½®: $config_to_delete"
    read -rp "$(print_color "$RED" "ç¡®è®¤åˆ é™¤? (y/N): ")" confirm
    
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶åˆ é™¤é…ç½®
        local temp_file
        temp_file=$(mktemp)
        awk -v config="$config_to_delete" '
            /^\[.*\]$/ {
                section = $0
                gsub(/[\[\]]/, "", section)
                if (section == config) {
                    skip = 1
                } else {
                    skip = 0
                    print $0
                }
                next
            }
            !skip { print $0 }
        ' "$KEYS_FILE" > "$temp_file"
        
        mv "$temp_file" "$KEYS_FILE"
        
        # å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é…ç½®ï¼Œæ¸…é™¤å½“å‰é…ç½®è®°å½•
        local current_config
        current_config=$(get_current_config)
        if [[ "$current_config" == "$config_to_delete" ]]; then
            rm -f "$CURRENT_FILE"
            rm -f "$SETTINGS_FILE"
            print_warning "å·²æ¸…é™¤å½“å‰é…ç½®è®°å½•å’Œ settings.json"
        fi
        
        print_success "é…ç½® '$config_to_delete' åˆ é™¤æˆåŠŸï¼"
    else
        print_info "åˆ é™¤æ“ä½œå·²å–æ¶ˆ"
    fi
}

# ç¼–è¾‘é…ç½®
edit_config() {
    print_title "ç¼–è¾‘ Claude API é…ç½®"
    
    local configs
    mapfile -t configs < <(get_all_configs)
    
    if [[ ${#configs[@]} -eq 0 ]]; then
        print_warning "æ²¡æœ‰å¯ç¼–è¾‘çš„é…ç½®"
        return 0
    fi
    
    list_configs
    
    local selection
    read -rp "$(print_color "$BOLD$YELLOW" "è¯·é€‰æ‹©è¦ç¼–è¾‘çš„é…ç½® (è¾“å…¥æ•°å­—æˆ–åç§°): ")" selection
    
    local config_to_edit=""
    
    if [[ "$selection" =~ ^[0-9]+$ ]]; then
        if [[ "$selection" -ge 1 && "$selection" -le ${#configs[@]} ]]; then
            config_to_edit="${configs[$((selection - 1))]}"
        else
            print_error "æ— æ•ˆçš„æ•°å­—é€‰æ‹©: $selection"
            return 1
        fi
    else
        if config_exists "$selection"; then
            config_to_edit="$selection"
        else
            print_error "é…ç½® '$selection' ä¸å­˜åœ¨"
            return 1
        fi
    fi
    
    # è·å–å½“å‰é…ç½®å€¼
    local current_base_url current_api_key
    current_base_url=$(get_config_value "$KEYS_FILE" "$config_to_edit" "baseUrl")
    current_api_key=$(get_config_value "$KEYS_FILE" "$config_to_edit" "apiKey")
    
    print_separator
    print_info "å½“å‰é…ç½® '$config_to_edit' çš„å†…å®¹:"
    echo "  Base URL: $current_base_url"
    echo "  API Key:  ...${current_api_key: -4}"
    echo
    
    local new_base_url new_api_key
    read -rp "$(print_color "$BOLD$WHITE" "æ–°çš„ Base URL (å›è½¦ä¿æŒä¸å˜): ")" new_base_url
    read -rp "$(print_color "$BOLD$WHITE" "æ–°çš„ API Key (å›è½¦ä¿æŒä¸å˜): ")" new_api_key
    
    # å¦‚æœç”¨æˆ·æ²¡è¾“å…¥ï¼Œä¿æŒåŸå€¼
    if [[ -z "$new_base_url" ]]; then
        new_base_url="$current_base_url"
    fi
    if [[ -z "$new_api_key" ]]; then
        new_api_key="$current_api_key"
    fi
    
    # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢é…ç½®
    local temp_file
    temp_file=$(mktemp)
    
    awk -v config="$config_to_edit" -v new_base_url="$new_base_url" -v new_api_key="$new_api_key" '
        /^\[.*\]$/ {
            section = $0
            gsub(/[\[\]]/, "", section)
            if (section == config) {
                print "["config"]"
                print "baseUrl = " new_base_url
                print "apiKey = " new_api_key
                skip = 1
            } else {
                skip = 0
                print $0
            }
            next
        }
        skip && /^\s*\[.*\]\s*$/ { skip = 0 }
        !skip { print $0 }
    ' "$KEYS_FILE" > "$temp_file"
    
    mv "$temp_file" "$KEYS_FILE"
    print_success "é…ç½® '$config_to_edit' ç¼–è¾‘æˆåŠŸï¼"
}

# ç¼–è¾‘æ¨¡æ¿
edit_template() {
    print_title "ç¼–è¾‘ settings.json æ¨¡æ¿"
    
    # ç¡®ä¿æ¨¡æ¿æ–‡ä»¶å­˜åœ¨
    create_default_template
    
    print_info "å½“å‰æ¨¡æ¿æ–‡ä»¶ä½ç½®: $TEMPLATE_FILE"
    print_info "æ¨¡æ¿æ”¯æŒä»¥ä¸‹å˜é‡:"
    echo "  {{API_KEY}}     - å½“å‰é…ç½®çš„ API Key"
    echo "  {{BASE_URL}}    - å½“å‰é…ç½®çš„ Base URL"  
    echo "  {{CONFIG_NAME}} - å½“å‰é…ç½®çš„åç§°"
    echo
    
    print_warning "è¯·ç¡®ä¿ JSON æ ¼å¼æ­£ç¡®ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´é…ç½®ç”Ÿæˆå¤±è´¥"
    echo
    
    # é€‰æ‹©ç¼–è¾‘å™¨
    local editor=""
    if command -v nano >/dev/null 2>&1; then
        editor="nano"
    elif command -v vim >/dev/null 2>&1; then
        editor="vim"
    elif command -v vi >/dev/null 2>&1; then
        editor="vi"
    else
        print_error "æœªæ‰¾åˆ°å¯ç”¨çš„ç¼–è¾‘å™¨ (nano, vim, vi)"
        return 1
    fi
    
    read -rp "$(print_color "$BOLD$WHITE" "æŒ‰ Enter é”®ä½¿ç”¨ $editor ç¼–è¾‘æ¨¡æ¿ï¼Œæˆ–è¾“å…¥ 'c' å–æ¶ˆ: ")" confirm
    if [[ "$confirm" =~ ^[Cc]$ ]]; then
        print_info "å·²å–æ¶ˆæ¨¡æ¿ç¼–è¾‘"
        return 0
    fi
    
    # å¤‡ä»½åŸæ¨¡æ¿
    local backup_file="${TEMPLATE_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
    cp "$TEMPLATE_FILE" "$backup_file"
    print_info "å·²åˆ›å»ºæ¨¡æ¿å¤‡ä»½: $backup_file"
    
    # å¯åŠ¨ç¼–è¾‘å™¨
    if "$editor" "$TEMPLATE_FILE"; then
        # éªŒè¯ JSON æ ¼å¼
        if command -v python3 >/dev/null 2>&1; then
            if python3 -m json.tool "$TEMPLATE_FILE" >/dev/null 2>&1; then
                print_success "æ¨¡æ¿ç¼–è¾‘æˆåŠŸï¼ŒJSON æ ¼å¼éªŒè¯é€šè¿‡ï¼"
            else
                print_error "JSON æ ¼å¼éªŒè¯å¤±è´¥ï¼"
                read -rp "æ˜¯å¦æ¢å¤å¤‡ä»½? (Y/n): " restore
                if [[ ! "$restore" =~ ^[Nn]$ ]]; then
                    cp "$backup_file" "$TEMPLATE_FILE"
                    print_info "å·²æ¢å¤åŸæ¨¡æ¿"
                fi
            fi
        else
            print_success "æ¨¡æ¿ç¼–è¾‘å®Œæˆï¼ˆæœªè¿›è¡Œæ ¼å¼éªŒè¯ï¼‰"
        fi
    else
        print_error "ç¼–è¾‘å™¨é€€å‡ºå¼‚å¸¸"
    fi
}

# åˆ‡æ¢é…ç½®
switch_config() {
    local target_config="$1"
    
    if ! config_exists "$target_config"; then
        print_error "é…ç½® '$target_config' ä¸å­˜åœ¨"
        return 1
    fi
    
    # ç”Ÿæˆsettings.jsonå¹¶ä¿å­˜å½“å‰é…ç½®åç§°
    if generate_settings "$target_config"; then
        echo "$target_config" > "$CURRENT_FILE"
        return 0
    else
        return 1
    fi
}

# äº¤äº’å¼èœå•
interactive_menu() {
    while true; do
        clear
        print_title "é…ç½®ç®¡ç†ä¸»èœå•"
        
        local current_config
        current_config=$(get_current_config)
        if [[ -n "$current_config" ]]; then
            print_color "$GREEN" "$ICON_CONFIG å½“å‰é…ç½®: $current_config"
            echo
        fi
        
        list_configs
        
        print_separator
        printf "${BOLD}${WHITE}æ“ä½œé€‰é¡¹:${NC}\n"
        printf "${CYAN}[1-9]${NC}     åˆ‡æ¢åˆ°å¯¹åº”ç¼–å·çš„é…ç½®\n"
        printf "${CYAN}[a]dd${NC}     æ·»åŠ æ–°é…ç½®\n"
        printf "${CYAN}[d]elete${NC}  åˆ é™¤é…ç½®\n"
        printf "${CYAN}[e]dit${NC}    ç¼–è¾‘é…ç½®\n"
        printf "${CYAN}[t]emplate${NC} ç¼–è¾‘ settings.json æ¨¡æ¿\n"
        printf "${CYAN}[l]ist${NC}    åˆ·æ–°é…ç½®åˆ—è¡¨\n"
        printf "${CYAN}[h]elp${NC}    æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯\n"
        printf "${CYAN}[q]uit${NC}    é€€å‡ºç¨‹åº\n"
        print_separator
        
        local choice
        read -rp "$(print_color "$BOLD$WHITE" "è¯·é€‰æ‹©æ“ä½œ: ")" choice
        
        case "$choice" in
            [1-9])
                local configs
                mapfile -t configs < <(get_all_configs)
                if [[ "$choice" -le ${#configs[@]} ]]; then
                    switch_config "${configs[$((choice - 1))]}"
                    read -rp "$(print_color "$CYAN" "æŒ‰ Enter é”®ç»§ç»­...")"
                else
                    print_error "æ— æ•ˆçš„é…ç½®ç¼–å·"
                    read -rp "$(print_color "$CYAN" "æŒ‰ Enter é”®ç»§ç»­...")"
                fi
                ;;
            a|add)
                add_config
                read -rp "$(print_color "$CYAN" "æŒ‰ Enter é”®ç»§ç»­...")"
                ;;
            d|delete)
                delete_config
                read -rp "$(print_color "$CYAN" "æŒ‰ Enter é”®ç»§ç»­...")"
                ;;
            e|edit)
                edit_config
                read -rp "$(print_color "$CYAN" "æŒ‰ Enter é”®ç»§ç»­...")"
                ;;
            t|template)
                edit_template
                read -rp "$(print_color "$CYAN" "æŒ‰ Enter é”®ç»§ç»­...")"
                ;;
            l|list)
                continue
                ;;
            h|help)
                show_help
                read -rp "$(print_color "$CYAN" "æŒ‰ Enter é”®ç»§ç»­...")"
                ;;
            q|quit)
                print_info "æ„Ÿè°¢ä½¿ç”¨ Claude Config Switcherï¼"
                exit 0
                ;;
            *)
                print_error "æ— æ•ˆçš„é€‰æ‹©: $choice"
                read -rp "$(print_color "$CYAN" "æŒ‰ Enter é”®ç»§ç»­...")"
                ;;
        esac
    done
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    clear
    print_title "å¸®åŠ©ä¿¡æ¯"
    
    cat << EOF
${BOLD}ç”¨æ³•:${NC}
  ccs                        æ˜¾ç¤ºäº¤äº’å¼èœå•
  ccs <é…ç½®å>               ç›´æ¥åˆ‡æ¢åˆ°æŒ‡å®šé…ç½®
  ccs <æ•°å­—>                 åˆ‡æ¢åˆ°åˆ—è¡¨ä¸­ç¬¬Nä¸ªé…ç½®
  ccs add                    æ·»åŠ æ–°é…ç½®
  ccs delete                 åˆ é™¤é…ç½®
  ccs edit                   ç¼–è¾‘é…ç½®
  ccs template               ç¼–è¾‘ settings.json æ¨¡æ¿
  ccs update                 æ£€æŸ¥å¹¶æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬
  ccs list                   åˆ—å‡ºæ‰€æœ‰é…ç½®
  ccs help                   æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

${BOLD}ç¤ºä¾‹:${NC}
  ccs                        # è¿›å…¥äº¤äº’å¼èœå•
  ccs production             # åˆ‡æ¢åˆ° production é…ç½®
  ccs 1                      # åˆ‡æ¢åˆ°ç¬¬1ä¸ªé…ç½®
  ccs add                    # æ·»åŠ æ–°é…ç½®

${BOLD}æ–‡ä»¶ä½ç½®:${NC}
  é…ç½®ç›®å½•: ${CLAUDE_DIR}
  é…ç½®æ–‡ä»¶: ${KEYS_FILE}
  è®¾ç½®æ–‡ä»¶: ${SETTINGS_FILE}
  æ¨¡æ¿æ–‡ä»¶: ${TEMPLATE_FILE}
  å½“å‰é…ç½®: ${CURRENT_FILE}

${BOLD}é…ç½®æ ¼å¼:${NC}
  [é…ç½®åç§°]
  baseUrl = https://api.anthropic.com
  apiKey = sk-ant-xxxxx

${BOLD}é¡¹ç›®åœ°å€:${NC}
  GitHub: ${REPO_URL}
  ä½œè€…: ${GITHUB_USER}

EOF
}

# =============================================================================
# ä¸»ç¨‹åº
# =============================================================================

main() {
    # åˆå§‹åŒ–Claudeç›®å½•
    if ! init_claude_dir; then
        exit 1
    fi
    
    # æ£€æŸ¥æ›´æ–°ï¼ˆåå°é™é»˜è¿›è¡Œï¼‰
    check_for_updates "$@"
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    case "${1:-}" in
        "")
            interactive_menu
            ;;
        add)
            add_config
            ;;
        delete)
            delete_config
            ;;
        edit)
            edit_config
            ;;
        template)
            edit_template
            ;;
        list)
            list_configs
            ;;
        update)
            force_update "$@"
            ;;
        help|-h|--help)
            show_help
            ;;
        [1-9])
            local configs
            mapfile -t configs < <(get_all_configs)
            if [[ "$1" -le ${#configs[@]} ]]; then
                switch_config "${configs[$((1 - 1))]}"
            else
                print_error "æ— æ•ˆçš„é…ç½®ç¼–å·: $1"
                exit 1
            fi
            ;;
        *)
            # å°è¯•ä½œä¸ºé…ç½®åç§°
            if config_exists "$1"; then
                switch_config "$1"
            else
                print_error "æœªçŸ¥å‘½ä»¤æˆ–é…ç½®: $1"
                print_info "ä½¿ç”¨ 'ccs help' æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯"
                exit 1
            fi
            ;;
    esac
}

# è¿è¡Œä¸»ç¨‹åº
main "$@"